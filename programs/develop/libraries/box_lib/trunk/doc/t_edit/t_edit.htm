<html>
<head>
<title>элемент Text Editor</title>
<meta http-equiv="content-type" content="text/html; charset=WINDOWS-1251">
<link href="../style.css" type=text/css rel=stylesheet>
</head>

<body>
<p><a href="../box_lib.htm">На главную &uarr;</a></p>
<h1>Оглавление</h1>

<p><a href="#vveden">Введение</a></p>
<p><a href="#funct">Функции</a></p>
<ul>
<li><a href="#fun_but_copy">ted_but_copy</a></li>
<li><a href="#fun_but_cut">ted_but_cut</a></li>
<li><a href="#fun_but_find">ted_but_find</a></li>
<li><a href="#fun_but_find_next">ted_but_find_next</a></li>
<li><a href="#fun_but_paste">ted_but_paste</a></li>
<li><a href="#fun_but_redo">ted_but_redo</a></li>
<li><a href="#fun_but_reverse">ted_but_reverse</a></li>
<li><a href="#fun_but_save_file">ted_but_save_file</a></li>
<li><a href="#fun_but_select_word">ted_but_select_word</a></li>
<li><a href="#fun_but_sumb_lover">ted_but_sumb_lover</a></li>
<li><a href="#fun_but_sumb_upper">ted_but_sumb_upper</a></li>
<li><a href="#fun_but_undo">ted_but_undo</a></li>
<li><a href="#fun_can_save">ted_can_save</a></li>
<li><a href="#fun_clear">ted_clear</a></li>
<li><a href="#fun_delete">ted_delete</a></li>
<li><a href="#fun_draw">ted_draw</a></li>
<li><a href="#fun_init">ted_init</a></li>
<li><a href="#fun_init_scroll_bars">ted_init_scroll_bars</a></li>
<li><a href="#fun_init_syntax_file">ted_init_syntax_file</a></li>
<li><a href="#fun_is_select">ted_is_select</a></li>
<li><a href="#fun_key">ted_key</a></li>
<li><a href="#fun_mouse">ted_mouse</a></li>
<li><a href="#fun_open_file">ted_open_file</a></li>
<li><a href="#fun_text_add">ted_text_add</a></li>
<li><a href="#fun_text_colored">ted_text_colored</a></li>
<li><a href="#fun_go_to_position">ted_go_to_position</a></li>
</ul>
<p><a href="#syn_file">Формат файла подсветки *.syn</a></p>
<p><a href="#struc_tedit">Структура tedit</a></p>

<h1><a name="vveden">Введение</a></h1>
<p>Элемент text_editor позволяет работать с текстовыми файлами, содержит много функций для редактирования текста.</p>
<p><img src="../../../../../../other/t_edit/t_edit.png"></p>
<p>Внешний вид программы, с элементом text_editor.</p>

<h2>Возможности элемента</h2>
<ul>
  <li>Открытие (Ctrl+O), Сохранение файла (Ctrl+S, Ctrl+Shift+S).</li>
  <li>Редактирование: Повтор/Отмена действия (Ctrl+Z), Вырезать, Копировать (Ctrl+C), Вставить (Ctrl+V), Поиск (Ctrl+F, F3), Замена (Ctrl+H), Переход на строку (Ctrl+G).</li>
  <li>Выделение цветом слов, заданных в файле синтаксиса. Вывод справки по ним, если она есть (нажатием F1 когда курсор на слове).</li>
</ul>

<h2>О работе элемента</h2>
<p>Раздел для программистов (и интересующихся людей), в котором расказаны
  некоторые идеи, на которых построена данная программа.</p>

<p>Для работы с текстом программа использует структуры:</p>
<pre>struct symbol
  c db ?	;  +0 символ
  col db ?	;  +1 цвет
  perv dd ? ;  +2
  next dd ? ;  +6 указатели
  tc dd ?	; +10 врем. создания
  td dd ?	; +14 врем. удаления
ends</pre>
<p>Каждая из таких структур сохраняет один символ в переменной 'c'. Переменные
  'perv' и 'next' хранят индексы первого и следующего символов. Благодаря чему
  текст создается в виде цепочки символов (двунаправленный список).</p>
<p><b>'tc'</b> - время создания символа, при отмене действия текстовый редактор "знает"
  какие символы отображать, а какие нет (хотя все символы "висят" в памяти).</p>
<p><b>'td'</b> - время удаления символа, заполняется при удалении, при отмене действия
  удаления символов, текст может быть восстановлен.</p>
<p><b>'col'</b> - используется для цветовой разметки, содержит индекс цвета в массиве цветов ted_text_colors.</p>

<h1><a name="funct">Функции</a></h1>
<h2>Функции на экспорт:</h2>

<h4><a name="fun_but_copy">ted_but_copy</a></h4>
<p>Функция которая будет вызываться при нажатии на кнопку копирования в буфер или на <b>Ctrl+C</b>. Текст копируется в буфер <b>ted_buffer</b>, максимальный размер буфера указывается в <b>ted_buffer_size</b>.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_copy], tedit0</pre>

<h4><a name="fun_but_cut">ted_but_cut</a></h4>
<p>Функция вырезает выделенный текст и копирует его в буфер.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_cut], tedit0</pre>

<h4><a name="fun_but_find">ted_but_find</a></h4>
<p>Функция для поиска текста. Ищет текст из буфера <b>ted_buffer_find</b>, при нахождении перемещает курсор к найденому тексту и выделяет его. Принимает 2 параметра:</p>
<p>1) структура tedit,</p>
<p>2) параметры поиска:</p>
<ul>
<li>0 - искать ниже курсора</li>
<li>1 - искать выше курсора</li>
<li>2 - искать от начала документа</li>
</ul>
<p>Пример использования:</p>
<pre>stdcall [ted_but_find], tedit0, 2</pre>

<h4><a name="fun_but_find_next">ted_but_find_next</a></h4>
<p>Функция для поиска текста. Ищет текст из буфера <b>ted_buffer_find</b>, при нахождении перемещает курсор к найденому тексту и выделяет его. Поиск ведется ниже текущего положения курсора.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_find_next], tedit0</pre>

<h4><a name="fun_but_paste">ted_but_paste</a></h4><p></p>
<p>Функция вставляет текст из буфера <b>ted_buffer</b>.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_paste], tedit0</pre>

<h4><a name="fun_but_redo">ted_but_redo</a></h4>
<p>Повторяет отмененные действия по редактированию текста.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_redo], tedit0</pre>

<h4><a name="fun_but_reverse">ted_but_reverse</a></h4>
<p>Меняет порядок следования символов в выделенном тексте.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_reverse], tedit0</pre>

<h4><a name="fun_but_save_file">ted_but_save_file</a></h4>
<p>Функция для сохранения файла. Принимает 3 параметра:</p>
<p>1) структура tedit,</p>
<p>2) структура для работы 70-й функции (до вызова функции заполнения не требует),</p>
<p>3) строка с путем и именем файла.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_save_file], tedit0,run_file_70,[edit1.text]</pre>

<h4><a name="fun_but_select_word">ted_but_select_word</a></h4>
<p>Функция для выделения ключевого слова под курсором. Если ключевые слова не используются, тогда будет выделен весь текст.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_select_word], tedit0</pre>

<h4><a name="fun_but_sumb_lover">ted_but_sumb_lover</a></h4>
<p>Переводит выделенные символы к нижнему регистру.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_sumb_lover], tedit0</pre>

<h4><a name="fun_but_sumb_upper">ted_but_sumb_upper</a></h4>
<p>Переводит выделенные символы к верхнему регистру.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_sumb_upper], tedit0</pre>

<h4><a name="fun_but_undo">ted_but_undo</a></h4>
<p>Отменяет действия по редактированию текста. Действия функции <b>ted_but_reverse</b> не отменяются.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_but_undo], tedit0</pre>

<h4><a name="fun_can_save">ted_can_save</a></h4>
<p>Функция которая проверяет были ли не сохраненные изменения в тексте. Результат возвращается в регистр <b>al</b>, если изменения были то возвращает 1 иначе 0.</p>
<p>Пример использования:</p>
<pre>push eax
	stdcall [ted_can_save], tedit0
	cmp al,1
.........
pop eax</pre>

<h4><a name="fun_clear">ted_clear</a></h4>
<p>Очистка текста в окне редактора. Принимает 2 параметра:</p>
<p>1) структура tedit,</p>
<p>2) параметр определяет будет ли очистка памяти полной.</p>
<p>Если 2-й параметр равен 1, то очистка будет полной, при 0 нет. Пользователю нужно вызывать функцию с параметром 1, параметр 0 для внутреннего использования.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_clear], tedit0,1</pre>

<h4><a name="fun_delete">ted_delete</a></h4>
<p>Деструктор элемента, освобождает память занятую элементом.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_delete], tedit0</pre>

<h4><a name="fun_draw">ted_draw</a></h4>
<p>Перерисовка всего окна редактора, включая дочерние скроллинги.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_draw], tedit0</pre>

<h4><a name="fun_init">ted_init</a></h4>
<p>Конструктор элемента, выделяет память необходимую для работы текстового редактора.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_init], tedit0</pre>

<h4><a name="fun_init_scroll_bars">ted_init_scroll_bars</a></h4>
<p>Устанавливает цвет скроллингов и настраивает их размеры в зависимости от размеров окна. Можно вызывать эту функцию при изменении размеров окна в пользовательской программе. Принимает 2 параметра:</p>
<p>1) структура tedit,</p>
<p>2) опции, указывают какие нужно изменить параметры:</p>
<ul>
<li>1 - изменить цвета скроллингов</li>
<li>2 - изменился размер окна</li>
<li>4 - изменился размер документа</li>
</ul>
<p>Параметры можно комбинировать через <i>логическое или</i>.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_init_scroll_bars], tedit0,2</pre>

<h4><a name="fun_init_syntax_file">ted_init_syntax_file</a></h4>
<p>Функция для загрузки цветов интерфейса и ключевых слов из файла синтаксиса. Принимает 3 параметра:</p>
<p>1) структура tedit,</p>
<p>2) структура для работы 70-й функции (до вызова функции заполнения не требует),</p>
<p>3) строка с путем и именем файла синтаксиса.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_init_syntax_file], tedit0,run_file_70,file_name</pre>

<h4><a name="fun_is_select">ted_is_select</a></h4>
<p>Определяет есть в окне редактора выделенный текст. Если есть в регистр <b>al</b> записывается 1 иначе 0. Функция необходима для создания панелей инстрементов, в которых в зависимости от выделения будут доступны или заблокированы определенные кнопки (действия). Например кнопку для копирования в буфер можно заблокировать если нет выбранного текста.</p>
<p>Пример использования:</p>
<pre>push eax edi
	mov edi,tedit0
	call [ted_is_select]
	cmp al,0
.........
pop edi eax</pre>

<h4><a name="fun_key">ted_key</a></h4>
<p>Функция вызываемая для реакции на клавиатуру. В регистре <b>eax</b> должен быть код нажатой клавиши. Принимает 3 параметра:</p>
<p>1) структура tedit,</p>
<p>2) таблица для конвертации scan кодов в ascii,</p>
<p>3) управляющие символы.</p>
<p>Пример использования:</p>
<pre>mcall 66,3 ;66.3 получить состояние управляющих клавиш
xor esi,esi
mov ecx,1
test al,0x03 ;[Shift]
jz @f
	mov cl,2
	or esi,KM_SHIFT
@@:
test al,0x0c ;[Ctrl]
jz @f
	or esi,KM_CTRL
@@:
test al,0x30 ;[Alt]
jz @f
mov cl,3
	or esi,KM_ALT
@@:
test al,0x80 ;[NumLock]
jz @f
	or esi,KM_NUMLOCK
@@:

mcall 26,2,,conv_tabl ;26.2 получить раскладку клавиатуры
mcall 2 ;получаем код нажатой клавиши
stdcall [ted_key], tedit0, conv_tabl,esi</pre>

<h4><a name="fun_mouse">ted_mouse</a></h4>
<p>Функция на перемещение или нажатие мыши.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_mouse], tedit0</pre>

<h4><a name="fun_open_file">ted_open_file</a></h4>
<p>Функция для открытия файла. Принимает 3 параметра:</p>
<p>1) структура tedit,</p>
<p>2) структура для работы 70-й функции (до вызова функции заполнения не требует),</p>
<p>3) строка с путем и именем файла.</p>
<p>Возвращает 2 параметра:</p>
<p>1) eax = код ошибки</p>
<p>2) ebx = колличество прочитанных байт</p>
<p>Пример использования:</p>
<pre>push eax ebx
stdcall [ted_open_file], tedit0,run_file_70,[edit1.text]
.........
pop ebx eax</pre>

<h4><a name="fun_text_add">ted_text_add</a></h4>
<p>Функция для добавления текста. Принимает 4 параметра:</p>
<p>1) структура tedit,</p>
<p>2) указатель на буфер с текстом,</p>
<p>3) длина текста,</p>
<p>4) опции вставки.</p>
<p>Пример использования:</p>
<pre>text_buffer db 500 dup(0)
.........
mov ebx,ted_opt_ed_change_time+ted_opt_ed_move_cursor
stdcall [ted_text_add], tedit0,text_buffer,30,ebx</pre>
<p><b>ted_opt_ed_change_time</b> - фиксировать изменения документа, что-бы их можно было отменить. Например если нужно сделать несколько изменений текста, которые будут отменяться за один раз, то 1-е изменение идет с этой константой а остальные нет.</p>
<p><b>ted_opt_ed_move_cursor</b> - константа которая определяет сдвиг курсора после добавления текста.</p>

<h4><a name="fun_text_colored">ted_text_colored</a></h4>
<p>Функция для разметки текста цветом. Обычно вызывается внутри самой библиотеки, при изменениях текста. В некоторых случаях может понадобиться вызвать принудительно из внешней программы.</p>
<p>Пример использования:</p>
<pre>push edi
	mov edi,tedit0
	call [ted_text_colored]
pop edi</pre>

<h4><a name="fun_go_to_position">ted_go_to_position</a></h4>
<p>Функция для перехода на указанную позицию. Принимает 3 параметра:</p>
<p>1) структура tedit,</p>
<p>2) номер строки,</p>
<p>3) номер символа.</p>
<p>Пример использования:</p>
<pre>stdcall [ted_go_to_position], tedit0,50,3</pre>

<h2>Внутренние функции:</h2>
<p><b>ted_get_text_perv_pos</b> - переход на предыдущий символ в цепи (через указатель 'perv')</p>
<p><b>ted_get_text_next_pos</b> - переход на следующий символ в цепи (через указатель 'next')</p>
<p><b>ted_symbol_not_vis</b> - определяет видимый ли указанный символ на экране (в зависимости
      от значений 'tc' и 'td')</p>
<p><b>ted_iterat_next</b> - переход на следующий видимый символ в цепи. Использует для
      работы функции ted_get_text_next_pos и ted_symbol_not_vis.</p>
<p><b>ted_iterat_perv</b> - переход на предедущий видимый символ в цепи.</p>

<p><b>ted_iterat_next_pos_char</b> - найти следующую позицию указанного символа (edx-поз. начала
      поиска, bl->код искомого символа)</p>
<p><b>ted_get_pos_by_coords</b> - берет позицию символа по координатам (esi->коорд. x, знак;
      ecx->коорд. y, строка)</p>
<p><b>ted_go_to_pos</b> - переставляет курсор в указанную позицию, если указанная позиция
      находится вне экрана, то также переставляются скролинги (ecx->коорд. x, знак; edx->коорд. y, строка)</p>

<h1><a name="syn_file">Формат файла подсветки *.syn</a></h1>
<table>
<tr><th>Элемент</th><th>Размер (байт)</th></tr>
<tr><td>Количество цветов текста</td>
  <td><pre>4</pre></td></tr>
<tr><td>Количество подсвечиваемых слов</td>
  <td><pre>4</pre></td></tr>
<tr><td>Цвета интерфейса</td>
  <td><pre>4*6</pre></td></tr>
<tr><td>Цвета для текста</td>
  <td><pre>4*(кол. цв. текста)</pre></td></tr>
<tr><td>Структуры со свойствами и описаниями слов</td>
  <td><pre>sizeof(TexColViv)*(кол. слов)</pre></td></tr>
<tr><td>Разделительный символ, означающий начало описаний слов (всегда равен 0)</td>
  <td><pre>1 байт</pre></td></tr>
<tr><td>Описания слов (строки текста с 0-ми в конце)</td>
  <td><pre>(длинна справочного текста + 1)</pre></td></tr>
</table>
<h4>Замечания.</h4>
<ul>
<li>Все слова должны быть расположены в порядке следования их ASCII кодов.
  Возможно в будущих версиях формат файлов подсветки будет изменен.</li>
</ul>

<h1><a name="struc_tedit">Структура tedit</a></h1>
<p>Макроса для создания структуры текстового редактора нет. Потому данные для него задаются вручную. Пример структуры для текстового редактора:</p>
<pre>align 4
tedit0: ;структура текстового редактора
	.wnd BOX 195,5+20,325,260 ;+ 0
	.rec BOX 30,13,7,10   ;+16
	.drag_m db 0 ;+32 выделение от мыши
	.drag_k db 0 ;+33 выделение от клавиатуры
	.sel  TexSelect 0,0,0,0 ;+34 структура выделения
	.seln TexSelect ;+50 дополнительная структура выделения
	.tex	  dd 0 ;+66 text memory pointer
	.tex_1	  dd 0 ;+70 text first symbol pointer
	.tex_end  dd 0 ;+74 text end memory pointer
	.cur_x	  dd 0 ;+78 координата x курсора
	.cur_y	  dd 0 ;+82 координата y курсора
	.max_chars dd 5002 ;+86 максимальное число символов в одном документе
	.count_colors_text dd 1 ;+90 колличество цветов текста
	.count_key_words   dd 0 ;+94 колличество ключевых слов
	.color_cursor	   dd 0xff0000 ;+98 цвет курсора
	.color_wnd_capt    dd 0x0080c0 ;+102 цвет полей вокруг окна
	.color_wnd_work    dd	   0x0 ;+106 цвет фона окна
	.color_wnd_bord    dd 0xffffff ;+110 цвет текста на полях
	.color_select	   dd 0x0000ff ;+114 цвет выделения
	.color_cur_text    dd 0xffff00 ;+118 цвет символа под курсором
	.color_wnd_text    dd 0x80ffff ;+122 цвет текста в окне
	.syntax_file	   dd 0 ;+126 указатель на начало файла синтаксиса
	.syntax_file_size  dd 500 ;+130 максимальный размер файла синтаксиса
	.text_colors	   dd 0 ;+134 указатель на массив цветов текста
	.help_text_f1	   dd 0 ;+138 указатель на текст справки (по нажатии F1)
	.help_id	   dd -1 ;+142 идентификатор для справки
	.key_words_data    dd 0 ;+146 указатель на структуры ключевых слов TexColViv
	.tim_ch      dd ? ;+150 количество изменений в файле
	.tim_undo    dd ? ;+154 количество отмененных действий
	.tim_ls      dd ? ;+158 время последнего сохранения
	.tim_co      dd ? ;+162 время последней цветовой разметки
	.el_focus    dd el_focus ;+166 указатель на переменную элемента в фокусе
	.err_save    db 0 ;+170 ошибка сохранения файла
	.panel_id    db 0 ;+171 номер открытой панели
	.key_new     db 0 ;+172 символ, который будет добавлятся с клавиатуры
	.symbol_new_line db 20 ;+173 символ завершения строки
	.scr_w	     dd scrol_w1 ;+174 вертикальный скроллинг
	.scr_h	     dd scrol_h1 ;+178 горизонтальный скроллинг
	.arr_key_pos dd 0 ;+182 указатель на массив позиций ключевых слов
	.buffer      dd buf ;+186 указатель на буфер копирования/вставки
	.buffer_find dd 0 ;+190 указатель на буфер для поиска
	.cur_ins     db 1 ;+194 режим работы курсора (обычный или замена)
	.mode_color  db 1 ;+195 режим выделения слов цветом (0-выкл. 1-вкл.)
	.mode_invis  db 0 ;+196 режим показа непечатаемых символов
	.gp_opt      db 0 ;+197 опции возвращаемые функцией ted_get_pos_by_cursor
	.fun_on_key_ctrl_all dd but_ctrl_all ;+198 указатель на функцию вызываемую при нажатии Ctrl+N,O,S,F,H,G
	dd 0,0,0 ;зарезервировано
	.buffer_size       dd BUF_SIZE ;+214 размер буфера копирования/вставки
	.fun_find_err      dd 0 ;+218 указатель на функцию вызываемую если поиск закончился неудачно
	.fun_init_synt_err dd 0 ;+222 указатель на функцию вызываемую при ошибочном открытии файла синтаксиса
	.fun_draw_panel_buttons dd 0 ;+226 указатель на функцию рисования панели с кнопками
	.fun_draw_panels   dd 0 ;+230 указатель на функцию рисования панели поиска/замены/перехода/синтаксиса
	dd 0 ;зарезервировано
	.fun_save_err      dd 0 ;+238 указатель на функцию вызываемую если сохранение файла закончилось неудачно
	.increase_size dd 225 ;+242 число символов на которые будет увечиваться память при нехватке
	.ptr_free_symb dd   ? ;+246 указатель на свободную память, в которую можно добавлять символ (используется внутри элемента для ускорения вставки текста)
	.font_s dd ? ;+250 стили для шрифта (от 0 до 7 множитель для размера, +16 для второго системного шрифта)</pre>
<hr>
<p>Документация обновлялась последний раз 29.01.19.</p>

</body>
</html>